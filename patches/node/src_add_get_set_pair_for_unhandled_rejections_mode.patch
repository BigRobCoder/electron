From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Shelley Vohr <shelley.vohr@gmail.com>
Date: Thu, 3 Jun 2021 19:32:09 +0200
Subject: src: add get/set pair for unhandled rejections mode

This PR adds a get/set pair for unhandled rejections modes.

We do not want unhandled rejections to crash the process and want to
be able to control this effectively from C++ and not cli flag
which is the only option right now.

Upstreamed at https://github.com/nodejs/node/pull/38915.

diff --git a/src/env-inl.h b/src/env-inl.h
index 0cdb6e7f8e4c25c66faaf942d2cb10e34e4cb22e..4b0152afd91f187634a3b53d584f5c42ddb613fc 100644
--- a/src/env-inl.h
+++ b/src/env-inl.h
@@ -560,6 +560,24 @@ inline bool Environment::abort_on_uncaught_exception() const {
   return options_->abort_on_uncaught_exception;
 }
 
+inline void Environment::set_unhandled_rejections_mode(
+  const std::string& mode) {
+  if (!mode.empty() &&
+      mode != "warn-with-error-code" &&
+      mode != "throw" &&
+      mode != "strict" &&
+      mode != "warn" &&
+      mode != "none") {
+    fprintf(stderr, "Invalid unhandled rejections mode: %s\n", mode.c_str());
+  } else {
+    options_->unhandled_rejections = mode;
+  }
+}
+
+inline std::string Environment::unhandled_rejections_mode() const {
+  return options_->unhandled_rejections;
+}
+
 inline void Environment::set_force_context_aware(bool value) {
   options_->force_context_aware = value;
 }
diff --git a/src/env.h b/src/env.h
index 5233d40f0b09f3c6b646be8b789d01f461c4fb3f..a2fcba4421f54ad88e1875d318acda31535cf25b 100644
--- a/src/env.h
+++ b/src/env.h
@@ -1113,6 +1113,9 @@ class Environment : public MemoryRetainer {
   void PrintSyncTrace() const;
   inline void set_trace_sync_io(bool value);
 
+  inline void set_unhandled_rejections_mode(const std::string& mode);
+  inline std::string unhandled_rejections_mode() const;
+
   inline void set_force_context_aware(bool value);
   inline bool force_context_aware() const;
 
